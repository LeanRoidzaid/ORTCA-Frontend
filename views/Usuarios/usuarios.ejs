
<script>

function getBooleanCkecked(staus){
    if(staus=='on'){
        return true;
    }
    return false;
}



    function recuperar() {

        var usuario = $('#usuario').val();
        $.ajax({

            url: 'http://localhost:3000/usuarios/recuperar',
            type: 'POST',
            data: {
                'id': usuario
            },
            dataType: 'json',
            success: llenarFilas,
            error: function (request, error) {
                alert("Request: " + JSON.stringify(request.responseText));
            }
        });
        $('#RolesModal').modal('hide');


    }

    function eliminar(id){

    
        $.ajax({

            url: 'http://localhost:3000/usuarios/eliminar',
            type: 'POST',
            data: {
                'id': id
            },
            dataType: 'json',
            success: llenarFilas,
            error: function (request, error) {
                alert("Request: " + JSON.stringify(request.responseText));
            }
        });
        $('#RolesModal').modal('hide');



    }

    function actualizar() {
        var id = $('#id').val();
        var nombre = $('#nombre').val();
        var apellido = $('#apellido').val();
        var dni = $('#dni').val();
        var mail = $('#mail').val();
        var usuario = $('#usuario').val();



        var administrativo = $('#administrativo').prop('checked');
        var medico = $('#medico').prop('checked');
        var administrador = $('#administrador').prop('checked');
        var auditor = $('#auditor').prop('checked');

        var mensajeValidacion = "";



        if (typeof nombre == "undefined" || !(nombre.length > 1 && nombre.length < 45)) {
            mensajeValidacion += "El largo del nombre debe se mayor a 1 y menor a 45 \n ";
        }
        if (typeof apellido == "undefined" || !(apellido.length > 1 && apellido.length < 45)) {
            mensajeValidacion += "El largo del apellido debe se mayor a 1 y menor a 45 \n ";
        }
        if ((typeof dni == "undefined") || !dni.length > 8) {
            mensajeValidacion += "El DNI no debe ser mayor a 8 caracteres \n ";
        }
        var regex = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;

        if ((typeof mail == "undefined") || (!regex.test(mail)) || (!mail.length > 3 && mail.length < 45)) {
            mensajeValidacion += "El mail debe ser una direccion de correo valida. \n ";
        }


        if( administrativo==false && medico==false &&administrador==false &&auditor==false){
            mensajeValidacion += "Debe seleccionar al menos un rol para el usuario. \n ";
        }

        if (mensajeValidacion == "") {

            /*
            $.ajax({

                url: 'http://localhost:3000/usuarios/actualizar',
                type: 'POST',
                data: {
                    'id': id,
                    'nombre': nombre,
                    'apellido': apellido,
                    'usuario': usuario,
                    'dni': dni,
                    'mail': mail,
                    'administrativo': administrativo,
                    'medico': medico,
                    'administrador': administrador,
                    'auditor': auditor
                },
                dataType: 'json',
                success: function (data) {
                    $.ajax({

                        url: 'http://localhost:3000/usuarios/all',
                        type: 'GET',
                        data: {
                            'numberOfWords': 10
                        },
                        dataType: 'json',
                        success: bindData,
                        error: function (request, error) {
                            alert("Error: " + JSON.stringify(request));
                        }
                    });
                    $('#RolesModal').modal('hide')
                },
                error: function (request, error) {
                    alert("Request: " + JSON.stringify(request.responseText));
                }
            });
            */




            $.ajax({

                url: 'http://localhost:3000/usuarios/actualizar',
                type: 'POST',
                data: {
                    'id': id,
                    'nombre': nombre,
                    'apellido': apellido,
                    'usuario': usuario,
                    'dni': dni,
                    'mail': mail,
                    'administrativo': administrativo,
                    'medico': medico,
                    'administrador': administrador,
                    'auditor': auditor
                },
                dataType: 'json',
                success: function (data) {

                    llenarFilas();
                    $('#RolesModal').modal('hide')
                },
                error: function (request, error) {
                    alert("Request: " + JSON.stringify(request.responseText));
                }
            });
        }
        else {
            alert(mensajeValidacion);
            llenarFilas();
            //llenarFilas();
            //$('#RolesModal').modal('hide')
            return false;
        }

       
        //llenarFilas();
        return;
       

    }


    
function llenarFilas(){
    $.ajax({

            url : 'http://localhost:3000/usuarios/all',
            type : 'GET',
            data : {
                'numberOfWords' : 10
            },
            dataType:'json',
            success : bindData,
            error : function(request,error)
            {
                alert("Error: "+JSON.stringify(request));
            }
    });
}

 
function validarEmail(valor) {
  if (/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(valor)){
    return true;
  } else {
    return false;
  }
}
 
function insertarUsuario(datos){


    if(validarEmail(datos.item.mail)){

        $.ajax({

            url : 'http://localhost:3000/usuarios/insertar',
            type : 'POST',
            data : {
                'nombre' : datos.item.nombre,
                'apellido' : datos.item.apellido,
                'usuario' : datos.item.usuario,
                'dni' : datos.item.dni,
                'mail' : datos.item.mail,
            },
            dataType:'json',
            success : function(data){
                if(data.error=="Error al insertar usuarioSequelizeUniqueConstraintError: Validation error"){
                    alert("Error uds esta intentando ingresar un Usuario ya existente");
                }
                    

                
                llenarFilas();

                
          
            },
            error : function(request,error)
            {
                //alert("Request: "+JSON.stringify(request.responseText)+"  "+error+"  "+request);
                alert("Error al insertar usuario corrobore que no este insertando un usuario duplicado")
                llenarFilas();
                
            }
        });
        llenarFilas();




    }
    else{

        alert("Debe ingresar una direccion de correo valida.")

    }



    return;
}

function limpiarModal(){
    $('#id').val('');
    $('#nombre').val('');
    $('#apellido').val('');
    $('#dni').val('');
    $('#mail').val('');
    $('#usuario').val('');


    $('#medico').prop('checked',false);

    $('#administrativo').prop('checked',false);

    $('#auditor').prop('checked',false);

    $('#administrador').prop('checked',false);


}


function completarFormulario(data){
    $('#id').val(data.Id);
    $('#nombre').val(data.Nombre);
    $('#apellido').val(data.Apellido);
    $('#dni').val(data.Dni);
    $('#mail').val(data.Mail);
    $('#usuario').val(data.Usuario);


    for(var rol of data.roles){
        switch(rol){
            case 1:
                $('#medico').prop('checked',true);
                break;
            case 2:
                $('#administrativo').prop('checked',true);
                break;
            case 3:
                $('#auditor').prop('checked',true);
                break;
            case 4:
                $('#administrador').prop('checked',true);
                break;
        }
    }



     $('#RolesModal').modal();
}

function editarUsuario(args){



    
    limpiarModal();

    $.ajax({

        url: 'http://localhost:3000/usuarios/getUsuario',
        type: 'GET',
        data: {
            'idUsuario': args.item.id,
        },
        dataType: 'json',
        success: completarFormulario,
        error: function (request, error) {


        }
    });



}


function bindData(json){

    if(json.error){
        alert(json.error);
        return;

    }

    var usuario_roles = [
       
        { Name: "Medico", idRol: 1 },
        { Name: "Administrativo", idRol: 2 },
        { Name: "Auditor", idRol: 3 },
        { Name: "Administrador", idRol: 4 }
    ];


    

 
    $("#jsGrid").jsGrid({
        width: "1600",
        height: "1200",
        autoload: true,
        pageLoading: true,
        inserting: true,
        //editing: true,
        rowDoubleClick: editarUsuario,
        sorting: true,
        paging: true,
        selecting: true,
        deleteItem: function(item) {
            alert("eliminando");
            eliminar(item.id);
        //return $.ajax({
        //    type: "DELETE",
        //    url: "/items",
        //    data: item
        //});
        },
        onItemInserting: function(args) {
            insertarUsuario(args);
            // cancel insertion of the item with empty 'name' field
           // alert("Specify the name of the item!");
           // if(args.item.Edad === "") {
            //    args.cancel = true;
            //    alert("Specify the name of the item!");
            //}
        },
        onItemUpdating: function(args) {
        // cancel insertion of the item with empty 'name' field
        alert("Specify the name of the item!");
            if(args.item.Edad === "") {
                args.cancel = true;
                alert("Specify the name of the item!");
            }
        },
        data: json ,
        controller: {
            loadData: function(filter) {
                var startIndex = (filter.pageIndex - 1) * filter.pageSize;
                //alert("asdas"+filter.usuario_roles);
                return ;//{
                    //data: db.clients.slice(startIndex, startIndex + filter.pageSize),
                    //itemsCount: db.clients.length
                //};
            }
        } ,
        /*
        fields: [
            { name: "Usuario", type: "text", width: 150, validate: "required" },
            { name: "Edad", type: "number", width: 50 },
            { name: "Dir", type: "text", width: 200 },
            { name: "CAS", type: "select", items: countries, valueField: "Id", textField: "Name" },
            { name: "Activo", type: "checkbox", title: "Esta activo", sorting: false },
            { type: "control" }
        ]
        */
        fields: [
            { name: "id", title:"Id" , visible:false, type: "number", width: 5},
            { name: "nombre", title:"Nombre" , type: "text", width: 45,
            validate: {
                validator: "rangeLength",
                message: function(value, item) {
                    return "El largo del campo Nombre debe ser entre 1 y 45";
                },
                param: [1, 45]
            }
            },
            { name: "apellido", title: "Apellido" ,type: "text", width: 30, 
            validate: {
                validator: "rangeLength",
                message: function(value, item) {
                    return "El largo del campo Apellido debe ser entre 1 y 45";
                },
                param: [1, 45]
            }
            
            },
            { name: "dni",title:"DNI" ,type: "number", width: 15, 
            validate: {
                validator: "range",
                message: function(value, item) {
                    return "El numero del campo DNI debe ser entre 0 y 99999999 ";
                },
                param: [0, 99999999]
            }
            },
            { name: "mail", title:"Mail", type: "text", width: 60,             
            validate: {
                validator: "rangeLength",
                message: function(value, item) {
                    return "El largo del campo mail debe ser entre 5 y 45";
                },
                param: [5, 45]
            }
            },
            { name: "usuario",title:"Usuario", type: "text", width: 25, 
            validate: {
                validator: "rangeLength",
                message: function(value, item) {
                    return "El largo del campo usuario debe ser entre 5 y 45";
                },
                param: [5, 45]
            }
            },
            //{ name: "usuario_roles",visible:true, type: "select", items: usuario_roles, valueField: "idRol", textField: "Name" },
            { name: "fh_alta",title:"Fecha Alta" ,visible:false ,type: "text", width: 50, validate: "required" },
            { name: "fh_baja", visible:false, type: "text", width: 150},
            //{ name: "esMedico", title: "Medico",  type: "checkbox", width: 20},
            //{ name: "esAdministrativo", title: "Administrativo",  type: "checkbox", width: 40},
            //{ name: "esAuditor", title: "Auditor",  type: "checkbox", width: 20},
            //{ name: "esAdministrador", title: "Administrador",  type: "checkbox", width: 40}
            //,
            { type: "control",editButton: false, deleteButton:false }
        ]
    });

}



function errorCargarGrilla(response){

alert(response);

}





$(document).ready(function() {  


    $('#alertBag').hide(); 


    $.ajax({

            url : 'http://localhost:3000/usuarios/all',
            type : 'GET',
            data : {
                'numberOfWords' : 10
            },
            dataType:'json',
            success : bindData,
            error : errorCargarGrilla
        });

});
</script>




<link type="text/css" rel="stylesheet" href="stylesheets/jsgrid.min.css" />
<link type="text/css" rel="stylesheet" href="stylesheets/jsgrid-theme.min.css" />
    
<script type="text/javascript" src="javascripts/jsgrid/jsgrid.min.js"></script>
<div class="alert alert-primary"  id="alertBag" role="alert">
    
</div>
<h2>Usuarios</h2>
<br>

<div id="jsGrid" ></div>

<div class="modal fade" id="RolesModal" tabindex="-1" role="dialog" aria-labelledby="RolesModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="RolesModalLabel">Detalle Usuario</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form>
                    <input type="hidden" class="form-control" id="id" >
                <div class="form-group">
                  <label for="recipient-name" class="col-form-label">Nombre:</label>
                  <input type="text" class="form-control" id="nombre">
                </div>
                <div class="form-group">
                        <label for="recipient-name" class="col-form-label">Apellido:</label>
                        <input type="text" class="form-control" id="apellido">
                </div>
                <div class="form-group">
                        <label for="recipient-name" class="col-form-label">DNI:</label>
                        <input type="text" class="form-control" id="dni">
                </div>
                <div class="form-group">
                        <label for="recipient-name" class="col-form-label">Mail:</label>
                        <input type="text" class="form-control" id="mail">
                </div>
                <div class="form-group">
                        <label for="recipient-name" class="col-form-label">Usuario:</label>
                        <input type="text" class="form-control" id="usuario">
                </div>
                <div class="form-group">
                <label for="recipient-name" class="col-form-label">Roles</label>
                    <table>
                        <tr>
                            <td>Administrarivo</td>
                            <td><input type="checkbox"  id="administrativo"><br></td>
                        </tr>
                        <tr>
                            <td>Medico</td>
                            <td><input type="checkbox"  id="medico"></td>
                        </tr>
                        <tr>
                            <td>Administrador</td>
                            <td><input type="checkbox"  id="administrador"></td>
                        </tr>
                        <tr>
                            <td>Auditor</td>
                            <td><input type="checkbox"  id="auditor"></td>
                        </tr>
                    </table>
                        

                </div>
              </form>
            </div>
            <div class="modal-footer">
              
              <button type="button" class="btn btn-primary" onclick="recuperar();">Recuperar Password</button>
              <button type="button" class="btn btn-primary" onclick="actualizar();">Actualizar</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>

<script>

</script>

